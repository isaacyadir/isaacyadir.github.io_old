<!DOCTYPE html>
<html lang="en-us">
  <head>
    <script defer src="https://use.fontawesome.com/releases/v5.13.0/js/all.js"></script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.79.1" />


<title>Introduction to R Plumber : Expose a Caret model to a web API - Dr. Juan Camilo Orduz</title>
<meta property="og:title" content="Introduction to R Plumber : Expose a Caret model to a web API - Dr. Juan Camilo Orduz">


  <link href='../images/favicon.ico' rel='icon' type='image/x-icon'/>



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="../css/fonts.css" media="all">
<link rel="stylesheet" href="../css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="../" class="nav-logo">
    <img src="../images/sphere2.gif"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="../about/"> About</a></li>
    
    <li><a href="https://github.com/juanitorduz"><i class='fab fa-github fa-2x'></i>  </a></li>
    
    <li><a href="https://www.linkedin.com/in/juanitorduz/"><i class='fab fa-linkedin fa-2x' style='color:#0077B5;'></i>  </a></li>
    
    <li><a href="https://twitter.com/juanitorduz"><i class='fab fa-twitter fa-2x' style='color:#1DA1F2;'></i>  </a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">4 min read</span>
    

    <h1 class="article-title">Introduction to R Plumber : Expose a Caret model to a web API</h1>

    
    <span class="article-date">2018-10-12</span>
    

    <div class="article-content">
      <p>In this post we explore the basics of the <a href="https://www.rplumber.io">Plumber</a> package. Our aim is to ilustrate how to fit a \(L^2\)-regularized linear model and expose it to a web API so that we can request predictions.</p>
<h2 id="prepare-notebook">Prepare Notebook</h2>
<p>Let us load the necessary libraries.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(caret)
<span style="color:#a6e22e">library</span>(httr)
<span style="color:#a6e22e">library</span>(magrittr)
<span style="color:#a6e22e">library</span>(plumber)
<span style="color:#a6e22e">library</span>(tidyverse)
</code></pre></div><h2 id="load-data">Load Data</h2>
<p>As a toy example we consider the <code>mtcars</code> data set.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">df <span style="color:#f92672">&lt;-</span> mtcars <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_tibble</span>()

df <span style="color:#f92672">%&gt;%</span> head
</code></pre></div><pre><code>## # A tibble: 6 x 11
##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4
## 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4
## 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1
## 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1
## 5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
## 6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1
</code></pre><p>We want to fit a simple linear model to predict the variable <code>mpg</code>.</p>
<p><em>Warning:</em> We are not interested to find the &ldquo;best model&rdquo;. Better feature engineering and hyperparameter tunig is not developed here because it is not the main purpose.</p>
<h2 id="correlation-plot">Correlation Plot</h2>
<p>For variable selection we consider a correlation plot.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">df <span style="color:#f92672">%&gt;%</span> cor <span style="color:#f92672">%&gt;%</span> corrplot<span style="color:#f92672">::</span><span style="color:#a6e22e">corrplot</span>()
</code></pre></div><!-- raw HTML omitted -->
<p>From the visualization we see that the variables <code>wt</code>, <code>qsec</code> and <code>am</code> could be good predictors.</p>
<h2 id="define-and-train-model">Define and Train Model</h2>
<p>We are going to use the <a href="https://topepo.github.io/caret/index.html">Caret</a> package.</p>
<h3 id="split-data">Split Data</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)

<span style="color:#75715e"># Define observation matrix. </span>
X <span style="color:#f92672">&lt;-</span> df <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(wt, qsec, am)
<span style="color:#75715e"># Define target vector.</span>
y <span style="color:#f92672">&lt;-</span> df <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">pull</span>(mpg)

<span style="color:#75715e"># Define a partition of the data. </span>
partition <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">createDataPartition</span>(y <span style="color:#f92672">=</span> y, p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.75</span>, list <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) 

<span style="color:#75715e"># Split the data into a training and test set. </span>
df.train <span style="color:#f92672">&lt;-</span> df[partition, ]
df.test <span style="color:#f92672">&lt;-</span> df[<span style="color:#f92672">-</span> partition, ]

X.train <span style="color:#f92672">&lt;-</span> df.train <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(wt, qsec, am)
y.train <span style="color:#f92672">&lt;-</span> df.train <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">pull</span>(mpg)

X.test <span style="color:#f92672">&lt;-</span> df.test <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(wt, qsec, am)
y.test <span style="color:#f92672">&lt;-</span> df.test <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">pull</span>(mpg)
</code></pre></div><h3 id="data-pre-processing">Data Pre-Processing</h3>
<p>As we want to use a linear model, we neet to scale the variables.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Define scaler object. </span>
scaler.obj <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">preProcess</span>(x <span style="color:#f92672">=</span> X.train, method <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#39;center&#39;</span>, <span style="color:#e6db74">&#39;scale&#39;</span>))

<span style="color:#75715e"># Transform the data. </span>
X.train.scaled <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(object <span style="color:#f92672">=</span> scaler.obj, newdata <span style="color:#f92672">=</span> X.train)
X.test.scaled <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(object <span style="color:#f92672">=</span> scaler.obj, newdata <span style="color:#f92672">=</span> X.test)
</code></pre></div><h3 id="train-model">Train Model</h3>
<p>We fit \(L^2\)-regularization linear model using a 3-fold cross-validation to tune the regularization hyperparameter.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model.obj <span style="color:#f92672">&lt;-</span>  <span style="color:#a6e22e">train</span>(x <span style="color:#f92672">=</span> X.train.scaled,
                    y <span style="color:#f92672">=</span> y.train,
                    method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ridge&#39;</span>,
                    trControl <span style="color:#f92672">=</span> <span style="color:#a6e22e">trainControl</span>(method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cv&#39;</span>, number <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>), 
                    metric <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;RMSE&#39;</span>)
</code></pre></div><h3 id="model-evaluation">Model Evaluation</h3>
<p>Let us evaluate the model perforance.</p>
<p>On the training set:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model.obj<span style="color:#f92672">$</span>results <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">select</span>(RMSE)
</code></pre></div><pre><code>##       RMSE
## 1 2.613844
## 2 2.613700
## 3 2.554912
</code></pre><p>On the test set:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">y.pred <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(model.obj, newdata <span style="color:#f92672">=</span> X.test.scaled)

<span style="color:#a6e22e">RMSE</span>(pred <span style="color:#f92672">=</span> y.pred, obs <span style="color:#f92672">=</span> y.test)
</code></pre></div><pre><code>## [1] 2.664047
</code></pre><p>The model seems to be stable and there is no strong evidence of overfitting.</p>
<h3 id="visualization">Visualization</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">tibble</span>(y_test <span style="color:#f92672">=</span> y.test, y_pred <span style="color:#f92672">=</span> y.pred) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_light</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_point</span>(mapping <span style="color:#f92672">=</span> <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> y_test, y <span style="color:#f92672">=</span> y_pred)) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_smooth</span>(mapping <span style="color:#f92672">=</span> <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> y_test, y <span style="color:#f92672">=</span> y_pred, colour <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;y_pred ~ y_test&#39;</span>), method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;lm&#39;</span>, formula <span style="color:#f92672">=</span> y <span style="color:#f92672">~</span> x) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_abline</span>(mapping <span style="color:#f92672">=</span> <span style="color:#a6e22e">aes</span>(slope <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, intercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, colour <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;y_pred = y_test&#39;</span>), show.legend <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">ggtitle</span>(label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Model Evaluation&#39;</span>)
</code></pre></div><!-- raw HTML omitted -->
<h2 id="save-model">Save Model</h2>
<h3 id="data-pipeline">Data Pipeline</h3>
<p>We define a function which transforms and predicts for new incoming data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">GetNewPredictions <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(model, transformer, newdata){
  
  newdata.transformed <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(object <span style="color:#f92672">=</span> transformer, newdata <span style="color:#f92672">=</span> newdata)
  
  new.predictions <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(object <span style="color:#f92672">=</span> model, newdata <span style="color:#f92672">=</span> newdata.transformed)
  
  <span style="color:#a6e22e">return</span>(new.predictions)
  
}
</code></pre></div><h3 id="save-output-object">Save Output Object</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Define Output object.</span>
model.list <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">vector</span>(mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;list&#39;</span>)
<span style="color:#75715e"># Save scaler object.</span>
model.list<span style="color:#f92672">$</span>scaler.obj <span style="color:#f92672">&lt;-</span> scaler.obj
<span style="color:#75715e"># Save fitted model.</span>
model.list<span style="color:#f92672">$</span>model.obj <span style="color:#f92672">&lt;-</span> model.obj
<span style="color:#75715e"># Save transformation function. </span>
model.list<span style="color:#f92672">$</span>GetNewPredictions <span style="color:#f92672">&lt;-</span> GetNewPredictions

<span style="color:#a6e22e">saveRDS</span>(object <span style="color:#f92672">=</span> model.list, file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;model_list.rds&#39;</span>)
</code></pre></div><h2 id="write-plumber-script">Write Plumber Script</h2>
<p>This is the basic structure of a Plumber script.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># plumber.R</span>

<span style="color:#75715e"># Read model data.</span>
model.list <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">readRDS</span>(file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;model_list.rds&#39;</span>)

<span style="color:#75715e">#* @param wt</span>
<span style="color:#75715e">#* @param qsec</span>
<span style="color:#75715e">#* @param am</span>
<span style="color:#75715e">#* @post /predict</span>
CalculatePrediction <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(wt, qsec, am){
  
  wt <span style="color:#f92672">%&lt;&gt;%</span> as.numeric
  qsec <span style="color:#f92672">%&lt;&gt;%</span> as.numeric
  am <span style="color:#f92672">%&lt;&gt;%</span> as.numeric
  
  X.new <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(wt <span style="color:#f92672">=</span> wt, qsec <span style="color:#f92672">=</span> qsec, am <span style="color:#f92672">=</span> am)
  
  y.pred <span style="color:#f92672">&lt;-</span> model.list<span style="color:#f92672">$</span><span style="color:#a6e22e">GetNewPredictions</span>(model <span style="color:#f92672">=</span> model.list<span style="color:#f92672">$</span>model.obj, 
                                         transformer <span style="color:#f92672">=</span> model.list<span style="color:#f92672">$</span>scaler.obj, 
                                         newdata <span style="color:#f92672">=</span> X.new)
  
  <span style="color:#a6e22e">return</span>(y.pred)
}
</code></pre></div><h2 id="expose-to-api">Expose to API</h2>
<p>To expose the model and get predictions we run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">setwd</span>(dir <span style="color:#f92672">=</span> here<span style="color:#f92672">::</span><span style="color:#a6e22e">here</span>())

r <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">plumb</span>(file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;plumber.R&#39;</span>)

r<span style="color:#f92672">$</span><span style="color:#a6e22e">run</span>(port <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000</span>)
</code></pre></div><p>We can use a <code>POST</code> request to obtain predictions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">POST</span>(url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://localhost:8000/predict?am=1&amp;qsec=16.46&amp;wt=2.62&#39;</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">content</span>()
</code></pre></div><pre><code>## [1] 22.4974
</code></pre>
    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="../index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="../images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="../js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-122570825-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

